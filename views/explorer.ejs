<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Explorateur Blockchain | Terra Incognita</title>
    <link rel="stylesheet" href="<%= basePath %>/css/style.css" />
    <link rel="stylesheet" href="<%= basePath %>/css/explorer.css" />
  </head>
  <body class="explorer-body">
    <%- include('partials/header') %>

    <main class="explorer-main">
      <!-- Section Classement -->
      <section class="leaderboard-section">
        <div class="section-header">
          <span class="section-icon">ğŸ†</span>
          <h2>Top 10 Explorateurs</h2>
        </div>
        <div id="leaderboardList" class="explorer-leaderboard">
          <p class="muted">Chargement du classement...</p>
        </div>
      </section>

      <!-- LÃ©gende pÃ©dagogique -->
      <section class="pedagogy-banner">
        <div class="pedagogy-item">
          <span class="ped-icon">ğŸ”‘</span>
          <div>
            <strong>Hash</strong>
            <p>
              Empreinte numÃ©rique unique calculÃ©e Ã  partir du contenu du bloc.
              Toute modification le ferait changer.
            </p>
          </div>
        </div>
        <div class="pedagogy-item">
          <span class="ped-icon">ğŸ”—</span>
          <div>
            <strong>Hash prÃ©cÃ©dent</strong>
            <p>
              Chaque bloc contient l'empreinte du bloc prÃ©cÃ©dent, formant une
              chaÃ®ne inviolable.
            </p>
          </div>
        </div>
        <div class="pedagogy-item">
          <span class="ped-icon">ğŸ›¡ï¸</span>
          <div>
            <strong>ImmutabilitÃ©</strong>
            <p>
              Modifier un bloc invalide tous les suivants, rendant toute
              falsification dÃ©tectable immÃ©diatement.
            </p>
          </div>
        </div>
      </section>

      <div class="explorer-meta-row">
        <div class="meta-badge" id="totalBlocks">â€” blocs</div>
        <div class="meta-badge valid" id="integrityBadge">VÃ©rificationâ€¦</div>
      </div>

      <!-- Filtres -->
      <div class="explorer-toolbar">
        <div class="search-box">
          <span>ğŸ”</span>
          <input
            type="text"
            id="searchInput"
            placeholder="Rechercher un explorateur, un hash, des coordonnÃ©esâ€¦"
          />
        </div>
        <div class="toolbar-right">
          <span class="block-count-label" id="blockCountLabel"
            >Chargementâ€¦</span
          >
          <button id="refreshBtn" class="refresh-btn">â†º Actualiser</button>
        </div>
      </div>

      <!-- ChaÃ®ne de blocs -->
      <div id="chainContainer" class="chain-container">
        <div class="loading-chain">
          <div class="loading-spinner"></div>
          <p>Chargement de la blockchainâ€¦</p>
        </div>
      </div>
    </main>

    <!-- Modal de dÃ©tail -->
    <div id="blockModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card">
        <button class="modal-close" id="modalClose">âœ•</button>
        <div id="modalContent"></div>
      </div>
    </div>

    <script>
      let allBlocks = [];
      let displayedBlocks = [];
      let currentIndex = 0;
      const PAGE_SIZE = 20;
      let observer = null;

      // â”€â”€â”€ Fetch & render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      async function fetchChain() {
        try {
          const [blocksRes, integrityRes] = await Promise.all([
            fetch("<%= basePath %>/blocks", { cache: "no-store" }),
            fetch("<%= basePath %>/integrity", { cache: "no-store" }),
          ]);
          allBlocks = await blocksRes.json();
          const { isValid } = await integrityRes.json();

          updateStats(allBlocks.length, isValid);
          resetAndRender(allBlocks);
        } catch (err) {
          console.error("Erreur chargement chaine:", err);
          document.getElementById("chainContainer").innerHTML =
            '<p class="empty-chain">Erreur lors du chargement des blocs.</p>';
        }
      }

      function resetAndRender(blocks) {
        displayedBlocks = [...blocks].reverse();
        currentIndex = 0;
        const container = document.getElementById("chainContainer");
        container.innerHTML = "";

        if (displayedBlocks.length === 0) {
          container.innerHTML = '<p class="empty-chain">Aucun bloc trouvÃ©.</p>';
          document.getElementById("blockCountLabel").textContent = "0 bloc";
          return;
        }

        renderNextChunk();
        setupIntersectionObserver();
      }

      function renderNextChunk() {
        const container = document.getElementById("chainContainer");
        const nextChunk = displayedBlocks.slice(
          currentIndex,
          currentIndex + PAGE_SIZE,
        );

        if (nextChunk.length === 0) return;

        const fragment = document.createDocumentFragment();

        nextChunk.forEach((block, idx) => {
          const absoluteIdx = currentIndex + idx;
          const isGenesis = block.index === 0;
          const isLatest = block.index === allBlocks.length - 1;
          const isPixel = typeof block.data === "object" && block.data !== null;

          // Carte du bloc
          const card = document.createElement("div");
          card.className = `block-card ${isGenesis ? "genesis" : ""} ${isLatest ? "latest" : ""}`;
          card.dataset.index = block.index;

          const headerColor = isGenesis
            ? "genesis-header"
            : isPixel
              ? `pixel-header`
              : "default-header";

          const pixelSwatch = isPixel
            ? `<span class="pixel-swatch" style="background:${block.data.color}"></span>`
            : "";

          card.innerHTML = `
            <div class="block-header ${headerColor}">
              <div class="block-index">
                ${isGenesis ? "ğŸŒ Bloc Genesis" : `${isLatest ? "ğŸ†• " : ""}Bloc #${block.index}`}
              </div>
              <div class="block-badges">
                ${pixelSwatch}
                ${isLatest ? '<span class="badge-latest">DERNIER</span>' : ""}
              </div>
            </div>

            <div class="block-body">
              <div class="block-timestamp">ğŸ• ${block.timestamp}</div>

              ${
                isPixel
                  ? `
                <div class="block-data pixel-data">
                <div class="data-row">
                  <span class="data-label">Explorateur</span>
                  <span class="data-value owner-value">${escHtml(block.data.owner)}</span>
                </div>
                <div class="data-row">
                  <span class="data-label">CoordonnÃ©es</span>
                  <span class="data-value">X: ${block.data.x}, Y: ${block.data.y}</span>
                </div>
                <div class="data-row">
                  <span class="data-label">Terrain</span>
                  <span class="data-value">
                    <span class="color-pill" style="background:${block.data.color}"></span>
                    ${block.data.terrain || block.data.color}
                  </span>
                </div>
              </div>
              `
                  : `
              <div class="block-data genesis-data">
                <span class="genesis-label">ğŸ“œ ${escHtml(String(block.data))}</span>
              </div>
              `
              }

              <div class="hash-section">
                <div class="hash-row">
                  <span class="hash-label">ğŸ”‘ Hash</span>
                  <code class="hash-value current-hash" title="${block.hash}">${block.hash}</code>
                </div>
                <div class="hash-row">
                  <span class="hash-label">ğŸ”— Hash prÃ©c.</span>
                  <code class="hash-value prev-hash ${block.previousHash === "0" ? "zero-hash" : ""}" title="${block.previousHash}">
                    ${block.previousHash === "0" ? "0000â€¦ (Origine)" : block.previousHash}
                  </code>
                </div>
              </div>

              <button class="detail-btn" data-index="${block.index}">Voir le dÃ©tail complet â†’</button>
            </div>
          `;

          // Ajouter un Ã©couteur au bouton de dÃ©tail
          card.querySelector(".detail-btn").addEventListener("click", () => {
            openModal(block.index);
          });

          fragment.appendChild(card);

          // FlÃ¨che de liaison (sauf si c'est le dernier bloc affichÃ© ET que c'est le genesis)
          const isReallyLast = absoluteIdx === displayedBlocks.length - 1;
          if (!isReallyLast) {
            const arrow = document.createElement("div");
            arrow.className = "chain-arrow";
            arrow.innerHTML = `
              <div class="arrow-line"></div>
              <div class="arrow-label">
                <span class="arrow-hash" title="${block.previousHash}">${block.hash.slice(0, 12)}â€¦</span>
                <span class="arrow-text">â¬† rÃ©fÃ©rencÃ© par</span>
              </div>
              <div class="arrow-line"></div>
            `;
            fragment.appendChild(arrow);
          }
        });

        container.appendChild(fragment);
        currentIndex += nextChunk.length;

        // Mettre Ã  jour le label
        updateCountLabel();
      }

      function updateCountLabel() {
        const total = allBlocks.length;
        const showing = displayedBlocks.length;
        let text = `${showing} bloc${showing > 1 ? "s" : ""} dans la chaÃ®ne`;

        if (showing !== total) {
          text = `${showing} rÃ©sultat${showing > 1 ? "s" : ""} (sur ${total} blocs)`;
        }

        document.getElementById("blockCountLabel").textContent = text;

        // Masquer le sentinel si tout est affichÃ©
        const sentinel = document.getElementById("loadMoreSentinel");
        if (sentinel) {
          if (currentIndex >= displayedBlocks.length) {
            sentinel.style.display = "none";
          } else {
            sentinel.style.display = "flex";
          }
        }
      }

      function setupIntersectionObserver() {
        if (observer) observer.disconnect();

        // On crÃ©e un sentinel s'il n'existe pas
        let sentinel = document.getElementById("loadMoreSentinel");
        if (!sentinel) {
          sentinel = document.createElement("div");
          sentinel.id = "loadMoreSentinel";
          sentinel.className = "load-more-sentinel";
          sentinel.innerHTML = "<span>Chargement des blocs suivants...</span>";
          document.querySelector(".explorer-main").appendChild(sentinel);
        }

        observer = new IntersectionObserver(
          (entries) => {
            if (
              entries[0].isIntersecting &&
              currentIndex < displayedBlocks.length
            ) {
              renderNextChunk();
            }
          },
          { rootMargin: "200px" },
        );

        observer.observe(sentinel);
      }

      async function fetchLeaderboard() {
        try {
          const res = await fetch("<%= basePath %>/api/leaderboard", {
            cache: "no-store",
          });
          const leaderboard = await res.json();
          const list = document.getElementById("leaderboardList");

          if (leaderboard.length === 0) {
            list.innerHTML =
              '<p class="muted">Aucune case acquise pour le moment.</p>';
            return;
          }

          list.innerHTML = leaderboard
            .map(
              (item, index) => `
              <div class="leaderboard-card-item">
                <span class="leaderboard-rank">#${index + 1}</span>
                <span class="leaderboard-name">${escHtml(item.name)}</span>
                <span class="leaderboard-count">${item.count} case${item.count > 1 ? "s" : ""}</span>
              </div>
            `,
            )
            .join("");
        } catch (err) {
          console.error("Erreur classement:", err);
        }
      }

      function updateStats(count, isValid) {
        document.getElementById("totalBlocks").textContent =
          `${count} bloc${count > 1 ? "s" : ""}`;
        const badge = document.getElementById("integrityBadge");
        badge.textContent = isValid
          ? "âœ… ChaÃ®ne valide"
          : "âŒ ChaÃ®ne corrompue";
        badge.className = "meta-badge " + (isValid ? "valid" : "invalid");
      }

      // â”€â”€â”€ Recherche â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      document
        .getElementById("searchInput")
        .addEventListener("input", function () {
          const q = this.value.toLowerCase().trim();
          if (!q) {
            resetAndRender(allBlocks);
            return;
          }

          const filtered = allBlocks.filter((b) => {
            if (b.index === 0) return String(b.data).toLowerCase().includes(q);
            return (
              String(b.index).includes(q) ||
              b.hash.toLowerCase().includes(q) ||
              b.previousHash.toLowerCase().includes(q) ||
              b.timestamp.toLowerCase().includes(q) ||
              (b.data.owner && b.data.owner.toLowerCase().includes(q)) ||
              (b.data.color && b.data.color.toLowerCase().includes(q)) ||
              (b.data.x !== undefined && String(b.data.x).includes(q)) ||
              (b.data.y !== undefined && String(b.data.y).includes(q))
            );
          });

          resetAndRender(filtered);
        });

      // â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function openModal(index) {
        const block = allBlocks.find((b) => b.index === index);
        if (!block) return;

        const isPixel = typeof block.data === "object" && block.data !== null;

        document.getElementById("modalContent").innerHTML = `
          <h2 class="modal-title">${block.index === 0 ? "ğŸŒ Bloc Genesis" : `ğŸ§± Bloc #${block.index}`}</h2>
          <p class="modal-timestamp">ğŸ“… EnregistrÃ© le ${block.timestamp}</p>

          <div class="modal-section">
            <h3>DonnÃ©es</h3>
            ${
              isPixel
                ? `
            <table class="modal-table">
              <tr><td>Explorateur</td><td><strong>${escHtml(block.data.owner)}</strong></td></tr>
              <tr><td>Case X</td><td>${block.data.x}</td></tr>
              <tr><td>Case Y</td><td>${block.data.y}</td></tr>
              <tr><td>Terrain</td>
                  <td>
                    <span class="color-pill" style="background:${block.data.color}"></span>
                    ${block.data.terrain || block.data.color}
                  </td>
              </tr>
            </table>
            `
                : `<p class="genesis-label-modal">ğŸ“œ ${escHtml(String(block.data))}</p>`
            }
          </div>

          <div class="modal-section">
            <h3>ğŸ”‘ Hash (empreinte du bloc)</h3>
            <p class="modal-explain">Ce hash est calculÃ© Ã  partir de <em>toutes</em> les donnÃ©es du bloc. Le moindre changement produirait un hash totalement diffÃ©rent.</p>
            <code class="full-hash">${block.hash}</code>
          </div>

          <div class="modal-section">
            <h3>ğŸ”— Hash prÃ©cÃ©dent</h3>
            <p class="modal-explain">En stockant l'empreinte du bloc prÃ©cÃ©dent, chaque bloc <em>scelle</em> l'historique de toute la chaÃ®ne avant lui.</p>
            <code class="full-hash ${block.previousHash === "0" ? "zero-hash" : ""}">${block.previousHash}</code>
          </div>

          <div class="modal-section">
            <h3>ğŸ“ Formule de hachage</h3>
            <code class="formula-code">SHA256( index + previousHash + timestamp + JSON(data) )</code>
          </div>
        `;

        const modal = document.getElementById("blockModal");
        modal.setAttribute("aria-hidden", "false");
        modal.classList.add("visible");
      }

      document
        .getElementById("modalClose")
        .addEventListener("click", closeModal);
      document
        .getElementById("blockModal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeModal();
        });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });

      function closeModal() {
        const modal = document.getElementById("blockModal");
        modal.setAttribute("aria-hidden", "true");
        modal.classList.remove("visible");
      }

      // â”€â”€â”€ Utilitaires â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function escHtml(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      document
        .getElementById("refreshBtn")
        .addEventListener("click", fetchChain);

      // Init
      fetchChain();
      fetchLeaderboard();
    </script>
    <%- include('partials/footer') %>
  </body>
</html>

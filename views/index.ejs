<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Terra Incognita | Carte Blockchain Collaborative</title>
    <meta
      name="description"
      content="FaÃ§onnez un monde fictif case par case. Chaque territoire que vous acquÃ©rez est inscrit pour toujours dans la blockchain."
    />
    <link rel="stylesheet" href="<%= basePath %>/css/style.css" />
  </head>
  <body>
    <%- include('partials/header') %>
    <div class="layout">
      <!-- Panneau gauche : Bandeau Info -->
      <div class="leaderboard-card">
        <div class="app-logo">
          <span class="logo-icon">ğŸŒ</span>
          <div>
            <h2 class="app-title">Terra Incognita</h2>
            <p class="app-sub">Explorez les terres inconnues</p>
          </div>
        </div>

        <div class="legende">
          <h3 class="section-title">LÃ©gende du monde</h3>
          <div class="legende-item">
            <span class="legende-dot" style="background: #8b6040"></span>
            <span>Terre (Montagnes/DÃ©serts)</span>
          </div>
          <div class="legende-item">
            <span class="legende-dot" style="background: #6baadd"></span>
            <span>Eau (OcÃ©ans/Lacs)</span>
          </div>
          <div class="legende-item">
            <span class="legende-dot" style="background: #4caf50"></span>
            <span>VÃ©gÃ©tation (ForÃªts)</span>
          </div>
          <div class="legende-item">
            <span class="legende-dot" style="background: #e53935"></span>
            <span>Ville (Civilisation)</span>
          </div>
        </div>

        <div class="mission-info">
          <h3>ğŸ“œ Votre Mission</h3>
          <p>
            Chaque case acquise est gravÃ©e dans la blockchain. Le monde se
            construit collectivement, bloc par bloc. Une fois posÃ©, un terrain
            ne peut plus Ãªtre modifiÃ©.
          </p>
          <a href="<%= basePath %>/about" class="learn-more"
            >En savoir plus sur la blockchain â†’</a
          >
        </div>
      </div>

      <!-- Canvas central : la carte -->
      <div class="canvas-container">
        <div class="canvas-wrapper">
          <canvas id="gridCanvas" width="300" height="300"></canvas>
          <div id="tooltip" class="tooltip"></div>
        </div>
        <div class="canvas-footer">
          <span id="casesCount" class="cases-count"
            >0 / 10 000 cases acquises</span
          >
          <span class="canvas-hint"
            >ğŸ’¡ Cliquez sur une case pour la sÃ©lectionner</span
          >
        </div>
      </div>

      <!-- Panneau droit : ContrÃ´les -->
      <div class="controls">
        <div>
          <h1>FaÃ§onnez le Monde</h1>
          <p class="description">
            SÃ©lectionnez une case sur la carte, choisissez son terrain et
            inscrivez votre acquisition dans la blockchain.
          </p>
        </div>

        <div id="caseSelection" class="case-info">
          ğŸ“ Case sÃ©lectionnÃ©e : <strong id="coordText">â€”</strong>
        </div>

        <div class="field identity-box">
          <label>Votre IdentitÃ© Blockchain</label>
          <div class="wallet-info">
            <span class="wallet-icon">ğŸ†”</span>
            <span id="walletAddress" class="wallet-address">Chargement...</span>
          </div>
          <div class="wallet-actions">
            <button type="button" id="exportIdentity" class="action-btn-small">
              ğŸ’¾ Exporter
            </button>
            <button type="button" id="importIdentity" class="action-btn-small">
              ğŸ“¥ Importer
            </button>
          </div>
          <p class="field-hint">
            Votre identifiant unique est gÃ©nÃ©rÃ© localement. Il garantit votre
            anonymat tout en prouvant la propriÃ©tÃ© de vos cases.
          </p>
        </div>

        <div class="field">
          <label>Type de terrain</label>
          <div class="terrain-grid">
            <button
              type="button"
              class="terrain-btn"
              id="btn-terre"
              data-color="#8B6040"
              data-terrain="Terre"
            >
              <span class="terrain-icon">ğŸ”ï¸</span>
              <span class="terrain-label">Terre</span>
            </button>
            <button
              type="button"
              class="terrain-btn"
              id="btn-eau"
              data-color="#6BAADD"
              data-terrain="Eau"
            >
              <span class="terrain-icon">ğŸ’§</span>
              <span class="terrain-label">Eau</span>
            </button>
            <button
              type="button"
              class="terrain-btn"
              id="btn-vegetation"
              data-color="#4CAF50"
              data-terrain="VÃ©gÃ©tation"
            >
              <span class="terrain-icon">ğŸŒ¿</span>
              <span class="terrain-label">VÃ©gÃ©tation</span>
            </button>
            <button
              type="button"
              class="terrain-btn"
              id="btn-ville"
              data-color="#E53935"
              data-terrain="Ville"
            >
              <span class="terrain-icon">ğŸ™ï¸</span>
              <span class="terrain-label">Ville</span>
            </button>
          </div>
        </div>

        <div class="field">
          <label>CoordonnÃ©es (optionnel)</label>
          <div class="coord-row">
            <div class="coord-field">
              <span class="coord-label">X</span>
              <input type="number" id="posX" min="0" max="99" value="0" />
            </div>
            <div class="coord-field">
              <span class="coord-label">Y</span>
              <input type="number" id="posY" min="0" max="99" value="0" />
            </div>
          </div>
        </div>

        <button id="buyBtn" disabled>
          SÃ©lectionnez une case et un terrain
        </button>

        <div class="stats">
          <div class="stat-item">
            <span class="stat-label">Taille de la grille</span>
            <span class="stat-value">100 Ã— 100 cases</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">RÃ©solution d'une case</span>
            <span class="stat-value">3 Ã— 3 px</span>
          </div>
        </div>
      </div>
    </div>

    <script src="<%= basePath %>/js/identity.js"></script>
    <script>
      const GRID_SIZE = 100; // 100x100 cases
      const CELL_PX = 3; // chaque case = 3x3 pixels sur le canvas
      const CANVAS_SIZE = GRID_SIZE * CELL_PX; // 300px

      const COULEUR_DEFAUT = "#FFFFFF"; // blanc â€” inexplorÃ©
      const COULEURS = {
        "#8B6040": "Terre",
        "#6BAADD": "Eau",
        "#4CAF50": "VÃ©gÃ©tation",
        "#E53935": "Ville",
      };

      const canvas = document.getElementById("gridCanvas");
      const ctx = canvas.getContext("2d");
      const posXInput = document.getElementById("posX");
      const posYInput = document.getElementById("posY");
      const caseSelection = document.getElementById("caseSelection");
      const coordText = document.getElementById("coordText");
      const buyBtn = document.getElementById("buyBtn");
      const tooltip = document.getElementById("tooltip");

      // L'affichage est gÃ©rÃ© par le CSS et synchronisÃ© avec CANVAS_SIZE
      const canvasWrapper = document.querySelector(".canvas-wrapper");
      if (canvasWrapper) canvasWrapper.style.maxWidth = `${CANVAS_SIZE * 2}px`;

      let selectedColor = null;
      let selectedTerrain = null;
      let selectedX = null;
      let selectedY = null;
      let gridData = {};

      // â”€â”€â”€ Initialisation IdentitÃ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function initIdentity() {
        await window.identity.init();
        const walletDisplay = document.getElementById("walletAddress");
        if (walletDisplay) {
          walletDisplay.textContent = window.identity.address;
        }

        // Gestion de l'export
        document
          .getElementById("exportIdentity")
          .addEventListener("click", async () => {
            const data = await window.identity.exportIdentity();
            const blob = new Blob([data], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `terra-incognita-identity-${window.identity.address}.json`;
            a.click();
            URL.revokeObjectURL(url);
          });

        // Gestion de l'import
        document
          .getElementById("importIdentity")
          .addEventListener("click", async () => {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = ".json";
            input.onchange = async (e) => {
              const file = e.target.files[0];
              const reader = new FileReader();
              reader.onload = async (re) => {
                try {
                  await window.identity.importIdentity(re.target.result);
                  walletDisplay.textContent = window.identity.address;
                  alert("IdentitÃ© importÃ©e avec succÃ¨s !");
                  location.reload(); // Recharger pour rafraÃ®chir tout l'Ã©tat
                } catch (err) {
                  alert("Fichier d'identitÃ© invalide.");
                }
              };
              reader.readAsText(file);
            };
            input.click();
          });
      }

      // â”€â”€â”€ Terrain buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      document.querySelectorAll(".terrain-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".terrain-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          selectedColor = btn.dataset.color;
          selectedTerrain = btn.dataset.terrain;
          updateBuyBtn();
        });
      });

      function updateBuyBtn() {
        if (selectedX !== null && selectedColor !== null) {
          buyBtn.disabled = false;
          buyBtn.textContent = `Signer & AcquÃ©rir "${selectedTerrain}"`;
        } else if (selectedX === null && selectedColor !== null) {
          buyBtn.disabled = true;
          buyBtn.textContent = "SÃ©lectionnez une case sur la carte";
        } else if (selectedX !== null && selectedColor === null) {
          buyBtn.disabled = true;
          buyBtn.textContent = "Choisissez un type de terrain";
        } else {
          buyBtn.disabled = true;
          buyBtn.textContent = "SÃ©lectionnez une case et un terrain";
        }
      }

      // â”€â”€â”€ Dessin de la grille â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function drawGrid(grid) {
        // Fond blanc (inexplorÃ© â€” brouillard de guerre)
        ctx.fillStyle = COULEUR_DEFAUT;
        ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

        // Dessiner les cases acquises
        for (const key in grid) {
          const [x, y] = key.split(",").map(Number);
          ctx.fillStyle = grid[key].color;
          ctx.fillRect(x * CELL_PX, y * CELL_PX, CELL_PX, CELL_PX);
        }

        // Surligner la case sÃ©lectionnÃ©e
        if (selectedX !== null) {
          ctx.strokeStyle = "#FFD700";
          ctx.lineWidth = 0.5;
          ctx.strokeRect(
            selectedX * CELL_PX + 0.25,
            selectedY * CELL_PX + 0.25,
            CELL_PX - 0.5,
            CELL_PX - 0.5,
          );
        }
      }

      // â”€â”€â”€ Fetch donnÃ©es â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      async function fetchGrid() {
        const res = await fetch("<%= basePath %>/gridstate", {
          cache: "no-store",
        });
        gridData = await res.json();
        drawGrid(gridData);

        const count = Object.keys(gridData).length;
        const countEl = document.getElementById("casesCount");
        if (countEl) {
          countEl.textContent = `${count} / 10 000 cases acquises`;
        }
      }

      // â”€â”€â”€ Interaction canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function getCanvasCoords(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = CANVAS_SIZE / rect.width;
        const scaleY = CANVAS_SIZE / rect.height;
        const px = (e.clientX - rect.left) * scaleX;
        const py = (e.clientY - rect.top) * scaleY;
        return {
          x: Math.floor(px / CELL_PX),
          y: Math.floor(py / CELL_PX),
        };
      }

      canvas.addEventListener("click", (e) => {
        const { x, y } = getCanvasCoords(e);
        if (x < 0 || x >= GRID_SIZE || y < 0 || y >= GRID_SIZE) return;

        const key = `${x},${y}`;
        if (gridData[key]) {
          const data = gridData[key];
          alert(
            `Cette case appartient dÃ©jÃ  Ã  ${data.owner} (${COULEURS[data.color] || data.color}).`,
          );
          return;
        }

        selectedX = x;
        selectedY = y;
        posXInput.value = x;
        posYInput.value = y;
        coordText.textContent = `${x}, ${y}`;
        caseSelection.classList.add("active");
        drawGrid(gridData);
        updateBuyBtn();
      });

      // Tooltip au survol
      canvas.addEventListener("mousemove", (e) => {
        const { x, y } = getCanvasCoords(e);
        if (x < 0 || x >= GRID_SIZE || y < 0 || y >= GRID_SIZE) {
          tooltip.style.display = "none";
          return;
        }

        const key = `${x},${y}`;
        const rect = canvas.getBoundingClientRect();
        tooltip.style.left = `${e.clientX - rect.left + 10}px`;
        tooltip.style.top = `${e.clientY - rect.top + 10}px`;
        tooltip.style.display = "block";

        if (gridData[key]) {
          const data = gridData[key];
          tooltip.innerHTML = `<strong>${COULEURS[data.color] || data.color}</strong><br>ğŸ“ (${x}, ${y})<br>ğŸ‘¤ ${escHtml(data.owner)}`;
        } else {
          tooltip.innerHTML = `ğŸ“ (${x}, ${y})<br><em>Disponible</em>`;
        }
      });

      canvas.addEventListener("mouseleave", () => {
        tooltip.style.display = "none";
      });

      // Synchronisation des inputs manuels
      [posXInput, posYInput].forEach((input) => {
        input.addEventListener("change", () => {
          const x = parseInt(posXInput.value);
          const y = parseInt(posYInput.value);
          if (x >= 0 && x < 100 && y >= 0 && y < 100) {
            selectedX = x;
            selectedY = y;
            coordText.textContent = `${x}, ${y}`;
            caseSelection.classList.add("active");
            drawGrid(gridData);
            updateBuyBtn();
          }
        });
      });

      // â”€â”€â”€ Acquisition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      buyBtn.addEventListener("click", async () => {
        if (selectedX === null || selectedColor === null) return;

        // On prÃ©pare les donnÃ©es Ã  signer
        const payload = {
          x: selectedX,
          y: selectedY,
          color: selectedColor,
        };

        buyBtn.disabled = true;
        buyBtn.textContent = "Signature cryptographique...";

        try {
          // 1. Signature du message
          const message = JSON.stringify(payload);
          const signature = await window.identity.signMessage(message);
          const publicKey = await window.identity.getPublicKeyBase64();

          buyBtn.textContent = "Inscription blockchain...";

          // 2. Envoi avec la preuve d'identitÃ©
          const res = await fetch("<%= basePath %>/acquerir-case", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ...payload,
              signature,
              publicKey,
            }),
          });

          if (res.ok) {
            selectedX = null;
            selectedY = null;
            caseSelection.classList.remove("active");
            coordText.textContent = "â€”";
            await fetchGrid();
            updateBuyBtn();
          } else {
            const errData = await res.json();
            alert(errData.error || "Erreur lors de l'enregistrement.");
            buyBtn.disabled = false;
            updateBuyBtn();
          }
        } catch (err) {
          console.error(err);
          alert("Erreur lors de la signature ou de l'envoi.");
          buyBtn.disabled = false;
          updateBuyBtn();
        }
      });

      // â”€â”€â”€ Utilitaires â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function escHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      initIdentity();
      fetchGrid();
      setInterval(() => {
        fetchGrid();
      }, 5000);
    </script>
    <%- include('partials/footer') %>
  </body>
</html>
